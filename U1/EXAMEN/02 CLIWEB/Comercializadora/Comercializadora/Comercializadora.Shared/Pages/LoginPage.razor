@page "/login"
@layout Comercializadora.Shared.Layout.LoginLayout
@using Comercializadora.Shared.Services
@using System.ComponentModel.DataAnnotations
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Comercializadora - Iniciar Sesión</PageTitle>

<div class="login-container">
<div class="login-card">
    <!-- Layout responsive: dos columnas en pantallas grandes -->
    <div class="login-layout">
        <!-- Imagen/Header - lado izquierdo en pantallas grandes -->
        <div class="login-image-section">
            <div class="login-header">
                @* <div class="login-logo">
                    🏪
                </div> *@
                <h1 class="login-title">Comercializadora</h1>
            </div>
        </div>

        <!-- Formulario - lado derecho en pantallas grandes -->
        <div class="login-form-section">
            <div class="login-form">
                <h2 class="form-title">Iniciar Sesión</h2>
                <EditForm Model="loginModel" OnValidSubmit="HandleLogin" FormName="LoginForm">
                <DataAnnotationsValidator />
                
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger login-alert" role="alert">
                        @errorMessage
                    </div>
                }
                
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <div class="input-group">
                        <span class="input-group-text">👤</span>
                        <InputText class="@($"form-control {GetFieldCssClass(nameof(loginModel.Username))}")"
                                   @bind-Value="loginModel.Username"
                                   placeholder="Ingrese su usuario"
                                   autocomplete="username" />
                    </div>
                    <ValidationMessage For="@(() => loginModel.Username)" class="text-danger small mt-1" />
                </div>

                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <div class="input-group">
                        <span class="input-group-text">🔒</span>
                        <input type="@(showPassword ? "text" : "password")"
                               class="@($"form-control {GetFieldCssClass(nameof(loginModel.Password))}")"
                               @bind="loginModel.Password"
                               placeholder="Ingrese su contraseña"
                               autocomplete="current-password" />
                        <button type="button" class="btn btn-outline-secondary password-toggle"
                                @onclick="TogglePasswordVisibility">
                            @(showPassword ? "👁️" : "👁️‍🗨️")
                        </button>
                    </div>
                    <ValidationMessage For="@(() => loginModel.Password)" class="text-danger small mt-1" />
                </div>


                <div class="form-group">
                    <button type="submit" class="btn btn-primary login-btn" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Iniciando sesión...</span>
                            </div>
                        }
                        Iniciar Sesión
                    </button>
                </div>
                    </EditForm>

                    <!-- Footer info en el formulario -->
                    <div class="login-footer-inline">
                        <div class="credentials-hint">
                            <small class="text-muted">
                                💡 <strong>Credenciales:</strong> MONSTER / MONSTER9
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private EditContext? editContext;
    private bool isLoading = false;
    private bool showPassword = false;
    private string errorMessage = "";

    protected override void OnInitialized()
    {
        editContext = new EditContext(loginModel);
        
        // Si ya está autenticado, redirigir al home
        if (AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/", replace: true);
        }
    }

    private string GetFieldCssClass(string fieldName)
    {
        if (editContext == null) return "";
        
        var fieldIdentifier = new FieldIdentifier(loginModel, fieldName);
        var hasErrors = editContext.GetValidationMessages(fieldIdentifier).Any();
        
        return hasErrors ? "is-invalid" : "";
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        if (editContext?.Validate() != true)
        {
            errorMessage = "Por favor, complete todos los campos requeridos.";
            return;
        }

        isLoading = true;
        errorMessage = "";
        
        try
        {
            var success = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);
            
            if (success)
            {
                // Mostrar mensaje de éxito brevemente
                await JSRuntime.InvokeVoidAsync("console.log", "Login exitoso, redirigiendo...");
                
                // Redirigir al home
                Navigation.NavigateTo("/", replace: true);
            }
            else
            {
                errorMessage = "Credenciales inválidas. Verifique su usuario y contraseña.";
                
                // Limpiar campos para seguridad
                loginModel.Password = "";
                
                // Vibrar en dispositivos móviles si está disponible
                try
                {
                    await JSRuntime.InvokeVoidAsync("navigator.vibrate", 200);
                }
                catch { /* Ignorar si no está disponible */ }
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error de conexión. Intente nuevamente.";
            await JSRuntime.InvokeVoidAsync("console.error", "Login error:", ex.Message);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "El usuario es requerido")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "El usuario debe tener entre 2 y 50 caracteres")]
        public string Username { get; set; } = "";

        [Required(ErrorMessage = "La contraseña es requerida")]
        [StringLength(100, MinimumLength = 3, ErrorMessage = "La contraseña debe tener al menos 3 caracteres")]
        public string Password { get; set; } = "";
    }
}