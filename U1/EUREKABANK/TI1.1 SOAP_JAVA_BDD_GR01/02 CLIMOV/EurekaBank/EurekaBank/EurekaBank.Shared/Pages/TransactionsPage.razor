@page "/transactions"

@inject ITransactionService TransactionService
@inject SessionService SessionManager
@inject NavigationManager NavigationManager

<div class="container-responsive">
    @if (SessionManager.IsLoggedIn)
    {
        <!-- Header Section -->
        <div class="page-header mb-4">
            <div class="row align-items-center">
                <div class="col-12">
                    <h1 class="text-responsive-lg mb-2">
                        <span class="me-2">⚡</span>
                        Realizar Transacciones
                    </h1>
                    <p class="text-muted text-responsive-md">
                        Selecciona el tipo de transacción que deseas realizar
                    </p>
                </div>
            </div>
        </div>

        <!-- Pestañas de Navegación (Implementación Blazor) -->
        <div class="card card-responsive mb-4">
            <div class="card-header p-0">
                <ul class="nav nav-pills nav-fill" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(ActiveTab == "deposit" ? "active" : "") rounded-0 border-0" 
                                @onclick="@(() => SetActiveTab("deposit"))" 
                                type="button">
                            <span class="me-2">💰</span>
                            <span class="d-none d-sm-inline">Depósito</span>
                            <span class="d-sm-none">Dep.</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(ActiveTab == "withdraw" ? "active" : "") rounded-0 border-0" 
                                @onclick="@(() => SetActiveTab("withdraw"))" 
                                type="button">
                            <span class="me-2">💳</span>
                            <span class="d-none d-sm-inline">Retiro</span>
                            <span class="d-sm-none">Ret.</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(ActiveTab == "transfer" ? "active" : "") rounded-0 border-0" 
                                @onclick="@(() => SetActiveTab("transfer"))" 
                                type="button">
                            <span class="me-2">🔄</span>
                            <span class="d-none d-sm-inline">Transferencia</span>
                            <span class="d-sm-none">Trans.</span>
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Contenido de las Pestañas -->
            <div class="card-body">
                @if (ActiveTab == "deposit")
                {
                    <!-- ===== PESTAÑA DE DEPÓSITO ===== -->
                    <div class="transaction-form">
                        <div class="d-flex align-items-center mb-4">
                            <div class="action-icon bg-success me-3">
                                <span style="color: white; font-size: 1.5rem;">💰</span>
                            </div>
                            <div>
                                <h4 class="mb-1">Realizar Depósito</h4>
                                <p class="text-muted mb-0">Ingresa dinero a una cuenta bancaria</p>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">🏦</span>
                                    Código de Cuenta
                                </label>
                                <input class="form-control input-responsive" @bind="DepositModel.CodigoCuenta" placeholder="Ej: 00100001" maxlength="8" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">💵</span>
                                    Importe a Depositar
                                </label>
                                <input type="number" step="0.01" min="0" class="form-control input-responsive" @bind="DepositModel.Importe" placeholder="0.00" />
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-success btn-lg btn-responsive" @onclick="HandleDeposit" disabled="@(IsBusy || string.IsNullOrWhiteSpace(DepositModel.CodigoCuenta) || DepositModel.Importe <= 0)">
                                @if (IsBusy)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Procesando...</span>
                                }
                                else
                                {
                                    <span class="me-2">💰</span>
                                    <span>Realizar Depósito</span>
                                }
                            </button>
                        </div>
                    </div>
                }
                else if (ActiveTab == "withdraw")
                {
                    <!-- ===== PESTAÑA DE RETIRO ===== -->
                    <div class="transaction-form">
                        <div class="d-flex align-items-center mb-4">
                            <div class="action-icon bg-warning me-3">
                                <span style="color: white; font-size: 1.5rem;">💳</span>
                            </div>
                            <div>
                                <h4 class="mb-1">Realizar Retiro</h4>
                                <p class="text-muted mb-0">Retira dinero de una cuenta bancaria</p>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">🏦</span>
                                    Código de Cuenta
                                </label>
                                <input class="form-control input-responsive" @bind="WithdrawModel.CodigoCuenta" placeholder="Ej: 00100001" maxlength="8" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">🔐</span>
                                    Clave de la Cuenta
                                </label>
                                <input type="password" class="form-control input-responsive" @bind="WithdrawModel.ClaveCuenta" placeholder="Ingresa la clave" />
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">💵</span>
                                    Importe a Retirar
                                </label>
                                <input type="number" step="0.01" min="0" class="form-control input-responsive" @bind="WithdrawModel.Importe" placeholder="0.00" />
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-warning btn-lg btn-responsive" @onclick="HandleWithdraw" disabled="@(IsBusy || string.IsNullOrWhiteSpace(WithdrawModel.CodigoCuenta) || string.IsNullOrWhiteSpace(WithdrawModel.ClaveCuenta) || WithdrawModel.Importe <= 0)">
                                @if (IsBusy)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Procesando...</span>
                                }
                                else
                                {
                                    <span class="me-2">💳</span>
                                    <span>Realizar Retiro</span>
                                }
                            </button>
                        </div>
                    </div>
                }
                else if (ActiveTab == "transfer")
                {
                    <!-- ===== PESTAÑA DE TRANSFERENCIA ===== -->
                    <div class="transaction-form">
                        <div class="d-flex align-items-center mb-4">
                            <div class="action-icon bg-info me-3">
                                <span style="color: white; font-size: 1.5rem;">🔄</span>
                            </div>
                            <div>
                                <h4 class="mb-1">Realizar Transferencia</h4>
                                <p class="text-muted mb-0">Transfiere dinero entre cuentas bancarias</p>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">🏦</span>
                                    Cuenta de Origen
                                </label>
                                <input class="form-control input-responsive" @bind="TransferModel.CuentaOrigen" placeholder="Ej: 00100001" maxlength="8" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">🔐</span>
                                    Clave Cuenta Origen
                                </label>
                                <input type="password" class="form-control input-responsive" @bind="TransferModel.ClaveCuentaOrigen" placeholder="Clave de origen" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">🏪</span>
                                    Cuenta de Destino
                                </label>
                                <input class="form-control input-responsive" @bind="TransferModel.CuentaDestino" placeholder="Ej: 00200001" maxlength="8" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="me-2">💵</span>
                                    Importe a Transferir
                                </label>
                                <input type="number" step="0.01" min="0" class="form-control input-responsive" @bind="TransferModel.Importe" placeholder="0.00" />
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-info btn-lg btn-responsive" @onclick="HandleTransfer" disabled="@(IsBusy || string.IsNullOrWhiteSpace(TransferModel.CuentaOrigen) || string.IsNullOrWhiteSpace(TransferModel.ClaveCuentaOrigen) || string.IsNullOrWhiteSpace(TransferModel.CuentaDestino) || TransferModel.Importe <= 0)">
                                @if (IsBusy)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Procesando...</span>
                                }
                                else
                                {
                                    <span class="me-2">🔄</span>
                                    <span>Realizar Transferencia</span>
                                }
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Resultados -->
        @if (IsBusy)
        {
            <div class="text-center my-5">
                <div class="card card-responsive d-inline-block">
                    <div class="card-body text-center p-5">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                        <h4 class="mb-2">Procesando transacción...</h4>
                        <p class="text-muted mb-0">Por favor espera mientras procesamos tu solicitud</p>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(ResultMessage))
        {
            <div class="alert @ResultCssClass alert-dismissible fade show animate-fade-in" role="alert">
                @if (ResultCssClass.Contains("success"))
                {
                    <span class="me-2">✅</span>
                }
                else
                {
                    <span class="me-2">❌</span>
                }
                <strong>@ResultMessage</strong>
                <button type="button" class="btn-close" @onclick="ClearResult">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
        }
    }
    else
    {
        <!-- Unauthorized Access -->
        <div class="text-center" style="min-height: 60vh; display: flex; align-items: center; justify-content: center;">
            <div class="card card-responsive">
                <div class="card-body text-center p-5">
                    <div class="text-warning mb-4">
                        <span style="font-size: 4rem;">⚠️</span>
                    </div>
                    <h2 class="mb-3">Acceso Restringido</h2>
                    <p class="text-muted mb-4">
                        Necesitas iniciar sesión para realizar transacciones bancarias.
                    </p>
                    <button class="btn btn-primary btn-lg btn-responsive" @onclick="IrALogin">
                        <span class="me-2">🚪</span>
                        Iniciar Sesión
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Estado de la UI
    private string ActiveTab { get; set; } = "deposit"; // Pestaña activa por defecto
    private bool IsBusy { get; set; }
    private string? ResultMessage { get; set; }
    private string ResultCssClass { get; set; } = "alert-info";

    // Modelos para cada formulario
    private Core.Models.Requests.DepositRequest DepositModel { get; set; } = new();
    private Core.Models.Requests.DepositRequest WithdrawModel { get; set; } = new();
    private Core.Models.Requests.TransferRequest TransferModel { get; set; } = new();

    // Método para cambiar de pestaña
    private void SetActiveTab(string tabName)
    {
        ActiveTab = tabName;
        // Limpiar mensaje anterior cuando cambiamos de pestaña
        ClearResult();
        StateHasChanged();
    }

    // Lógica para el Depósito
    private async Task HandleDeposit()
    {
        await ExecuteTransaction(async () =>
        {
            // Asignamos datos fijos que no vienen del formulario
            DepositModel.CodigoEmpleado = SessionManager.CurrentUser?.Codigo ?? "N/A";
            DepositModel.CodigoTipoMovimiento = "001"; // Valor fijo para depósito
            DepositModel.ClaveCuenta = "123456"; // Valor por defecto o no requerido para depósito

            var response = await TransactionService.RealizarDepositoAsync(DepositModel);

            if (response.Exitoso)
            {
                ResultMessage = $"Depósito exitoso";
                ResultCssClass = "alert-success";
                DepositModel = new(); // Resetea el formulario
            }
            else
            {
                ResultMessage = $"Error: {response.Mensaje}";
                ResultCssClass = "alert-danger";
            }
        });
    }

    // Lógica para el Retiro
    private async Task HandleWithdraw()
    {
        await ExecuteTransaction(async () =>
        {
            WithdrawModel.CodigoEmpleado = SessionManager.CurrentUser?.Codigo ?? "N/A";
            WithdrawModel.CodigoTipoMovimiento = "002"; // Valor fijo para retiro

            var response = await TransactionService.RealizarRetiroAsync(WithdrawModel);

            if (response.Exitoso)
            {
                ResultMessage = $"Retiro exitoso";
                ResultCssClass = "alert-success";
                WithdrawModel = new();
            }
            else
            {
                ResultMessage = $"Error: {response.Mensaje}";
                ResultCssClass = "alert-danger";
            }
        });
    }

    // Lógica para la Transferencia
    private async Task HandleTransfer()
    {
        await ExecuteTransaction(async () =>
        {
            TransferModel.CodigoEmpleado = SessionManager.CurrentUser?.Codigo ?? "N/A";

            var response = await TransactionService.RealizarTransferenciaAsync(TransferModel);

            if (response.Exitoso)
            {
                ResultMessage = $"Transferencia exitosa.";
                ResultCssClass = "alert-success";
                TransferModel = new();
            }
            else
            {
                ResultMessage = $"Error: {response.Mensaje}";
                ResultCssClass = "alert-danger";
            }
        });
    }

    // Método auxiliar genérico para manejar el estado de carga y errores
    private async Task ExecuteTransaction(Func<Task> transactionLogic)
    {
        IsBusy = true;
        ResultMessage = null;
        StateHasChanged(); // Forzar actualización de UI

        try
        {
            await transactionLogic();
        }
        catch (Exception ex)
        {
            ResultMessage = $"Error inesperado al procesar la transacción: {ex.Message}";
            ResultCssClass = "alert-danger";
        }
        finally
        {
            IsBusy = false;
            StateHasChanged(); // Forzar actualización de UI
        }
    }

    private void ClearResult()
    {
        ResultMessage = null;
    }

    private void IrALogin()
    {
        NavigationManager.NavigateTo("/");
    }
}