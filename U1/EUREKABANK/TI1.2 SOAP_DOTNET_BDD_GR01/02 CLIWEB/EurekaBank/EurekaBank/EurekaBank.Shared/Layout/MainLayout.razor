@inherits LayoutComponentBase
@inject ApiServiceManager ApiManager
@inject SessionService SessionManager

<div class="app-container">
    <!-- Top Navigation Bar - SIEMPRE VISIBLE -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="@(SessionManager.IsLoggedIn ? "/home" : "/")">
                <span class="me-2">🏦</span>
                EurekaBank
            </a>

            <!-- Mobile menu toggle -->
            <button class="navbar-toggler" type="button" onclick="toggleMobileMenu()" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                @if (SessionManager.IsLoggedIn)
                {
                    <!-- Menu items para usuarios logueados -->
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <NavLink class="nav-link" href="home" Match="NavLinkMatch.All" @onclick="closeMobileMenu">
                                <span class="me-1">🏠</span>
                                Inicio
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="transactions" @onclick="closeMobileMenu">
                                <span class="me-1">💰</span>
                                Transacciones
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="reports" @onclick="closeMobileMenu">
                                <span class="me-1">📊</span>
                                Reportes
                            </NavLink>
                        </li>
                    </ul>
                }
                else
                {
                    <!-- Espacio vacío para usuarios no logueados -->
                    <div class="navbar-nav me-auto"></div>
                }

                <!-- API Selectors and User Info - SIEMPRE VISIBLES -->
                <div class="navbar-nav ms-auto d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-2 gap-lg-3">
                    <!-- API Selectors -->
                    <div class="d-flex flex-column flex-lg-row gap-2 w-100 w-lg-auto">
                        <div class="d-flex align-items-center gap-2">
                            <label class="text-white small d-lg-none mb-0">Protocolo:</label>
                            <select class="form-select form-select-sm" @bind="ApiManager.CurrentProtocol" style="min-width: 80px;">
                                <option value="@ApiProtocol.Rest">REST</option>
                                <option value="@ApiProtocol.Soap">SOAP</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label class="text-white small d-lg-none mb-0">Plataforma:</label>
                            <select class="form-select form-select-sm" @bind="ApiManager.CurrentPlatform" style="min-width: 80px;">
                                <option value="@ApiPlatform.Java">Java</option>
                                <option value="@ApiPlatform.DotNet">.NET</option>
                            </select>
                        </div>
                    </div>

                    @if (SessionManager.IsLoggedIn)
                    {
                        <!-- User Info -->
                        <div class="d-flex align-items-center text-white mt-2 mt-lg-0">
                            <span class="me-2">👨‍💼</span>
                            <span class="d-none d-md-inline">@SessionManager.CurrentUser?.Nombre</span>
                        </div>

                        <!-- Logout -->
                        <button class="btn btn-outline-light btn-sm mt-2 mt-lg-0" @onclick="Logout">
                            <span class="me-1">🚪</span>
                            <span class="d-none d-md-inline">Salir</span>
                        </button>
                    }
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    @if (SessionManager.IsLoggedIn)
    {
        <!-- Main Content with top padding for fixed navbar -->
        <main class="main-content-logged" style="padding-top: 64px !important; min-height: calc(100vh - 64px) !important;">
            <div class="container-fluid py-3">
                @Body
            </div>
        </main>
    }
    else
    {
        <!-- Login page with top padding for navbar -->
        <main class="main-content-login" style="padding-top: 64px !important; min-height: calc(100vh - 64px) !important;">
            @Body
        </main>
    }
</div>

<!-- JavaScript para el menú móvil y detección de plataforma -->
<script>
    // Detectar si estamos en MAUI
    (function() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isMaui = userAgent.includes('MauiBlazorApp') || 
                      window.location.protocol === 'ms-appx-web:' ||
                      window.location.protocol === 'app:' ||
                      typeof window.chrome === 'undefined' && typeof navigator.msSaveBlob === 'undefined';
        
        if (isMaui) {
            document.body.classList.add('maui-app');
            document.body.classList.add('blazor-server-app');
        }

        // Asegurar padding correcto en MAUI
        function ensureProperPadding() {
            const mainElements = document.querySelectorAll('main[class*="main-content"]');
            mainElements.forEach(main => {
                main.style.paddingTop = '64px';
                main.style.minHeight = 'calc(100vh - 64px)';
                main.style.position = 'relative';
                main.style.zIndex = '1';
            });

            // También aplicar al contenedor principal
            const containers = document.querySelectorAll('.container-responsive');
            containers.forEach(container => {
                if (!container.style.paddingTop || container.style.paddingTop === '0px') {
                    container.style.paddingTop = '1rem';
                }
            });
        }

        // Ejecutar inmediatamente y después de que el DOM se cargue
        ensureProperPadding();
        document.addEventListener('DOMContentLoaded', ensureProperPadding);
        
        // También ejecutar cuando Blazor termine de renderizar
        setTimeout(ensureProperPadding, 100);
        setTimeout(ensureProperPadding, 500);
        setTimeout(ensureProperPadding, 1000);
    })();

    window.toggleMobileMenu = function() {
        const navbarNav = document.getElementById('navbarNav');
        const isExpanded = navbarNav.classList.contains('show');
        
        if (isExpanded) {
            navbarNav.classList.remove('show');
        } else {
            navbarNav.classList.add('show');
        }
        
        // Actualizar aria-expanded
        const toggleButton = document.querySelector('.navbar-toggler');
        toggleButton.setAttribute('aria-expanded', !isExpanded);
    };

    window.closeMobileMenu = function() {
        const navbarNav = document.getElementById('navbarNav');
        navbarNav.classList.remove('show');
        
        const toggleButton = document.querySelector('.navbar-toggler');
        toggleButton.setAttribute('aria-expanded', 'false');
    };

    // Cerrar menú al hacer clic fuera
    document.addEventListener('click', function(event) {
        const navbar = document.querySelector('.navbar');
        const navbarNav = document.getElementById('navbarNav');
        
        if (navbar && !navbar.contains(event.target) && navbarNav.classList.contains('show')) {
            window.closeMobileMenu();
        }
    });
</script>

@code {
    protected override void OnInitialized()
    {
        // Usar InvokeAsync para asegurar que las actualizaciones de UI ocurran en el thread correcto
        ApiManager.PropertyChanged += async (s, e) => await InvokeAsync(StateHasChanged);
        SessionManager.PropertyChanged += async (s, e) => await InvokeAsync(StateHasChanged);
        
        base.OnInitialized();
    }

    private void Logout()
    {
        SessionManager.Logout();
        NavigationManager.NavigateTo("/", true);
    }

    private void closeMobileMenu()
    {
        // Llamar a la función JavaScript para cerrar el menú
        // En Blazor Server, esto se ejecutará automáticamente cuando se navegue
    }

    [Inject] private NavigationManager NavigationManager { get; set; } = default!;
}