@inherits LayoutComponentBase
@inject ApiServiceManager ApiManager
@inject SessionService SessionManager

<div class="app-container">
    @if (SessionManager.IsLoggedIn)
    {
        <!-- Top Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
            <div class="container-fluid">
                <!-- Brand -->
                <a class="navbar-brand d-flex align-items-center" href="/home">
                    <i class="bi bi-bank2 me-2"></i>
                    EurekaBank
                </a>

                <!-- Mobile menu toggle -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Navigation items -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <NavLink class="nav-link" href="home" Match="NavLinkMatch.All">
                                <i class="bi bi-house-door-fill me-1"></i>
                                Inicio
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="transactions">
                                <i class="bi bi-arrow-left-right me-1"></i>
                                Transacciones
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="reports">
                                <i class="bi bi-table me-1"></i>
                                Reportes
                            </NavLink>
                        </li>
                    </ul>

                    <!-- API Selectors and User Info -->
                    <div class="navbar-nav ms-auto d-flex flex-row align-items-center gap-3">
                        <!-- API Selectors -->
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" @bind="ApiManager.CurrentProtocol" style="width: auto;">
                                <option value="@ApiProtocol.Rest">REST</option>
                                <option value="@ApiProtocol.Soap">SOAP</option>
                            </select>
                            <select class="form-select form-select-sm" @bind="ApiManager.CurrentPlatform" style="width: auto;">
                                <option value="@ApiPlatform.Java">Java</option>
                                <option value="@ApiPlatform.DotNet">.NET</option>
                            </select>
                        </div>

                        <!-- User Info -->
                        <div class="d-flex align-items-center text-white">
                            <i class="bi bi-person-circle me-2"></i>
                            <span class="d-none d-md-inline">@SessionManager.CurrentUser?.Nombre</span>
                        </div>

                        <!-- Logout -->
                        <button class="btn btn-outline-light btn-sm" @onclick="Logout">
                            <i class="bi bi-box-arrow-right me-1"></i>
                            <span class="d-none d-md-inline">Salir</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content with top padding for fixed navbar -->
        <main class="main-content-logged" style="padding-top: 76px;">
            <div class="container-fluid py-3">
                @Body
            </div>
        </main>
    }
    else
    {
        <!-- Login page - no navigation -->
        <main class="main-content-login">
            @Body
        </main>
    }
</div>

@code {
    protected override void OnInitialized()
    {
        // Usar InvokeAsync para asegurar que las actualizaciones de UI ocurran en el thread correcto
        ApiManager.PropertyChanged += async (s, e) => await InvokeAsync(StateHasChanged);
        SessionManager.PropertyChanged += async (s, e) => await InvokeAsync(StateHasChanged);
        
        base.OnInitialized();
    }

    private void Logout()
    {
        SessionManager.Logout();
        NavigationManager.NavigateTo("/", true);
    }

    [Inject] private NavigationManager NavigationManager { get; set; } = default!;
}